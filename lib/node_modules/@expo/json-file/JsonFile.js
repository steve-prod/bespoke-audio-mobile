'use strict';var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var fsp=require('mz/fs');var _=require('lodash');var util=require('util');var JSON5=require('json5');var JsonFileError=require('./JsonFileError');var DEFAULT_OPTIONS={badJsonDefault:undefined,cantReadFileDefault:undefined,default:undefined,json5:false,space:2};var JsonFile=function(){function JsonFile(file,options){_classCallCheck(this,JsonFile);this.file=file;this.options=options;}_createClass(JsonFile,[{key:'readAsync',value:function readAsync(options){return _readAsync(this.file,this._getOptions(options));}},{key:'writeAsync',value:function writeAsync(object,options){return _writeAsync(this.file,object,this._getOptions(options));}},{key:'getAsync',value:function getAsync(key,defaultValue,options){return _getAsync(this.file,key,defaultValue,this._getOptions(options));}},{key:'setAsync',value:function setAsync(key,value,options){return _setAsync(this.file,key,value,this._getOptions(options));}},{key:'updateAsync',value:function updateAsync(key,value,options){return _updateAsync(this.file,key,value,this._getOptions(options));}},{key:'mergeAsync',value:function mergeAsync(sources,options){return _mergeAsync(this.file,sources,this._getOptions(options));}},{key:'deleteKeyAsync',value:function deleteKeyAsync(key,options){return _deleteKeyAsync(this.file,key,this._getOptions(options));}},{key:'deleteKeysAsync',value:function deleteKeysAsync(keys,options){return _deleteKeysAsync(this.file,keys,this._getOptions(options));}},{key:'rewriteAsync',value:function rewriteAsync(options){return _rewriteAsync(this.file,this._getOptions(options));}},{key:'_getOptions',value:function _getOptions(options){return _extends({},this.options,options);}}]);return JsonFile;}();function _readAsync(file,options){var json5=_getOption(options,'json5');return fsp.readFile(file,'utf8').then(function(json){try{if(json5){return JSON5.parse(json);}else{return JSON.parse(json);}}catch(e){var defaultValue=jsonParseErrorDefault(options);if(defaultValue===undefined){throw new JsonFileError('Error parsing JSON file: '+file,e);}else{return defaultValue;}}},function(error){var defaultValue=cantReadFileDefault(options);if(defaultValue===undefined){throw new JsonFileError('Can\'t read JSON file: '+file,error);}else{return defaultValue;}});}function _getAsync(file,key,defaultValue,options){return _readAsync(file,options).then(function(object){if(defaultValue===undefined&&!_.has(object,key)){throw new JsonFileError('No value at key path "'+key+'" in JSON object from: '+file);}return _.get(object,key,defaultValue);});}function _writeAsync(file,object,options){var space=_getOption(options,'space');var json5=_getOption(options,'json5');try{var json;if(json5){json=JSON5.stringify(object,null,space);}else{json=JSON.stringify(object,null,space);}}catch(e){throw new JsonFileError('Couldn\'t JSON.stringify object for file: '+file,e);}return fsp.writeFile(file,json,'utf8').then(function(){return object;});}function _setAsync(file,key,value,options){return _readAsync(file,options).then(function(object){object=_.set(object,key,value);return _writeAsync(file,object,options);});}var _updateAsync=util.deprecate(_setAsync);function _mergeAsync(file,sources,options){return _readAsync(file,options).then(function(object){_extends(object,sources);return _writeAsync(file,object,options);});}function _deleteKeyAsync(file,key,options){return _deleteKeysAsync(file,[key],options);}function _deleteKeysAsync(file,keys,options){return _readAsync(file,options).then(function(object){var didDelete=false;for(var i=0;i<keys.length;i++){var key=keys[i];if(object.hasOwnProperty(key)){delete object[key];didDelete=true;}}if(didDelete){return _writeAsync(file,object,options);}});}function _rewriteAsync(file,options){return _readAsync(file,options).then(function(object){return _writeAsync(file,object,options);});}function jsonParseErrorDefault(options){options=options||{};if(options.jsonParseErrorDefault===undefined){return options.default;}else{return options.jsonParseErrorDefault;}}function cantReadFileDefault(options){options=options||{};if(options.cantReadFileDefault===undefined){return options.default;}else{return options.cantReadFileDefault;}}function _getOption(options,field){if(options){if(options[field]!==undefined){return options[field];}}return DEFAULT_OPTIONS[field];}_extends(JsonFile,{readAsync:_readAsync,writeAsync:_writeAsync,getAsync:_getAsync,setAsync:_setAsync,updateAsync:_updateAsync,mergeAsync:_mergeAsync,deleteKeyAsync:_deleteKeyAsync,deleteKeysAsync:_deleteKeysAsync,rewriteAsync:_rewriteAsync});module.exports=JsonFile;